"use client"

import type React from "react"

import { useState } from "react"
import { validateEmail } from "./utils"

interface User {
  email: string
  username: string
  password: string
}

interface Comment {
  id: string
  username: string
  text: string
  date: string
  rating: number
}

export default function HomePage() {
  const [rating, setRating] = useState(0)
  const [showLogin, setShowLogin] = useState(false)
  const [showRegister, setShowRegister] = useState(false)
  const [currentUser, setCurrentUser] = useState<User | null>(null)
  const [loginError, setLoginError] = useState("")
  const [registerError, setRegisterError] = useState("")
  const [comments, setComments] = useState<Comment[]>(() => {
    if (typeof window !== "undefined") {
      return JSON.parse(localStorage.getItem("comments") || "[]")
    }
    return []
  })

  // Load users from localStorage
  const getUsers = (): User[] => {
    if (typeof window !== "undefined") {
      return JSON.parse(localStorage.getItem("users") || "[]")
    }
    return []
  }

  const handleRegister = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    const formData = new FormData(e.currentTarget)
    const email = formData.get("email") as string
    const username = formData.get("username") as string
    const password = formData.get("password") as string
    const confirmPassword = formData.get("confirmPassword") as string

    if (!validateEmail(email)) {
      setRegisterError("Ungültige Email-Adresse")
      return
    }

    if (password !== confirmPassword) {
      setRegisterError("Passwörter stimmen nicht überein")
      return
    }

    const users = getUsers()
    if (users.some((user) => user.email === email || user.username === username)) {
      setRegisterError("Benutzer existiert bereits")
      return
    }

    const newUser = { email, username, password }
    users.push(newUser)
    localStorage.setItem("users", JSON.stringify(users))
    setCurrentUser(newUser)
    setShowRegister(false)
    setRegisterError("")
  }

  const handleLogin = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    const formData = new FormData(e.currentTarget)
    const username = formData.get("username") as string
    const password = formData.get("password") as string

    const users = getUsers()
    const user = users.find((u) => u.username === username && u.password === password)

    if (user) {
      setCurrentUser(user)
      setShowLogin(false)
      setLoginError("")
    } else {
      setLoginError("Falsche Zugangsdaten")
    }
  }

  const handleLogout = () => {
    setCurrentUser(null)
  }

  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    const text = (e.currentTarget.elements.namedItem("comment") as HTMLTextAreaElement).value

    const newComment = {
      id: crypto.randomUUID(),
      username: currentUser?.username || "Anonym",
      text,
      date: new Date().toISOString(),
      rating,
    }

    const updatedComments = [newComment, ...comments]
    localStorage.setItem("comments", JSON.stringify(updatedComments))
    setComments(updatedComments)
    e.currentTarget.reset()
    setRating(0)
  }

  return (
    <>
      <div className="horizontal-lines"></div>
      <div className="vertical-lines"></div>
      <div className="glitch-lines"></div>
      <div className="content">
        <header>
          <h1>Zero Quest</h1>
          <p>Dein Portal in eine neue Dimension</p>
        </header>

        <div className="hologram-container">
          <div className="content-wrapper">
            <img
              src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/image%20(14)-8gNRNzWYgZDauzpEX2nxR8SqsGFdbV.png"
              alt="Holographic Frame"
              className="hologram-frame"
            />
            <div className="content-overlay">
              <h2>[System]</h2>
              <p>Neue Datei verfügbar!</p>
              <a
                href="https://www.dropbox.com/scl/fi/lxhfyucgfgov611emelo3/2025-01-03-20-15-00_OSKnHG3p.mp4?rlkey=6ayahrba5tgubxgxhqv4kln0b&st=p9skzizd&dl=0"
                className="download-button"
              >
                Download
              </a>
            </div>
          </div>
        </div>

        <section className="comment-section">
          <h2 className="gallery-title">Feedback</h2>

          {!currentUser ? (
            <div className="auth-buttons">
              <button onClick={() => setShowLogin(true)} className="download-button">
                Login
              </button>
              <button onClick={() => setShowRegister(true)} className="download-button">
                Registrieren
              </button>
              <p className="login-info">Du musst dich anmelden oder registrieren, um Feedback zu geben.</p>
            </div>
          ) : (
            <>
              <div className="user-info">
                <p>Eingeloggt als: {currentUser.username}</p>
                <button onClick={handleLogout} className="download-button">
                  Logout
                </button>
              </div>

              <div className="rating-container">
                {[1, 2, 3, 4, 5].map((star) => (
                  <span
                    key={star}
                    className={`rating-star ${star <= rating ? "active" : ""}`}
                    onClick={() => setRating(star)}
                  >
                    ★
                  </span>
                ))}
              </div>

              <form onSubmit={handleSubmit} className="comment-form">
                <div className="form-group">
                  <label className="form-label" htmlFor="comment">
                    Dein Feedback:
                  </label>
                  <textarea id="comment" className="form-textarea" required></textarea>
                </div>

                <button type="submit" className="submit-button">
                  Absenden
                </button>
              </form>
            </>
          )}

          {showLogin && (
            <div className="login-overlay">
              <div className="login-modal">
                <h3 className="gallery-title" style={{ marginBottom: "20px" }}>
                  Login
                </h3>
                <form onSubmit={handleLogin}>
                  <div className="form-group">
                    <label className="form-label">Benutzername:</label>
                    <input type="text" name="username" className="form-input" required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Passwort:</label>
                    <input type="password" name="password" className="form-input" required />
                  </div>
                  {loginError && <div className="error-message">{loginError}</div>}
                  <div className="modal-buttons">
                    <button type="submit" className="download-button">
                      Login
                    </button>
                    <button
                      type="button"
                      className="download-button"
                      onClick={() => {
                        setShowLogin(false)
                        setLoginError("")
                      }}
                    >
                      Abbrechen
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {showRegister && (
            <div className="login-overlay">
              <div className="login-modal">
                <h3 className="gallery-title" style={{ marginBottom: "20px" }}>
                  Registrieren
                </h3>
                <form onSubmit={handleRegister}>
                  <div className="form-group">
                    <label className="form-label">Email:</label>
                    <input type="email" name="email" className="form-input" required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Benutzername:</label>
                    <input type="text" name="username" className="form-input" required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Passwort:</label>
                    <input type="password" name="password" className="form-input" required />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Passwort bestätigen:</label>
                    <input type="password" name="confirmPassword" className="form-input" required />
                  </div>
                  {registerError && <div className="error-message">{registerError}</div>}
                  <div className="modal-buttons">
                    <button type="submit" className="download-button">
                      Registrieren
                    </button>
                    <button
                      type="button"
                      className="download-button"
                      onClick={() => {
                        setShowRegister(false)
                        setRegisterError("")
                      }}
                    >
                      Abbrechen
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          <div className="comments-list">
            {comments.map((comment) => (
              <div key={comment.id} className="comment-item">
                <div className="comment-header">
                  <span>{comment.username}</span>
                  <span>{new Date(comment.date).toLocaleDateString()}</span>
                </div>
                <div className="rating-container" style={{ justifyContent: "flex-start", margin: "10px 0" }}>
                  {[1, 2, 3, 4, 5].map((star) => (
                    <span
                      key={star}
                      className={`rating-star ${star <= comment.rating ? "active" : ""}`}
                      style={{ cursor: "default" }}
                    >
                      ★
                    </span>
                  ))}
                </div>
                <div className="comment-content">{comment.text}</div>
              </div>
            ))}
          </div>
        </section>

        <footer>
          <div className="login-area">
            {!currentUser ? (
              <div className="auth-buttons">
                <button onClick={() => setShowLogin(true)} className="download-button">
                  Login
                </button>
                <button onClick={() => setShowRegister(true)} className="download-button">
                  Registrieren
                </button>
              </div>
            ) : (
              <button onClick={handleLogout} className="download-button">
                Logout
              </button>
            )}
            {currentUser?.email === "zock868@gmail.com" && currentUser?.username === "admin" && (
              <a href="/admin/users" className="download-button" style={{ marginLeft: "10px" }}>
                Benutzer verwalten
              </a>
            )}
          </div>
          &copy; 2025 Zero Quest. Alle Rechte vorbehalten.
        </footer>
      </div>

      <style jsx global>{`
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&family=Share+Tech+Mono&display=swap');

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        :root {
          --main-color: #0ff;
          --secondary-color: #ff0080;
          --bg-color: #000;
        }

        @keyframes textShadow {
          0% {
            text-shadow: 0.4389924193300864px 0 1px rgba(0,30,255,0.5), -0.4389924193300864px 0 1px rgba(255,0,80,0.3), 0 0 3px;
          }
          5% {
            text-shadow: 2.7928974010788217px 0 1px rgba(0,30,255,0.5), -2.7928974010788217px 0 1px rgba(255,0,80,0.3), 0 0 3px;
          }
          100% {
            text-shadow: 0.4389924193300864px 0 1px rgba(0,30,255,0.5), -0.4389924193300864px 0 1px rgba(255,0,80,0.3), 0 0 3px;
          }
        }

        @keyframes flicker {
          0% { opacity: 0.87; }
          5% { opacity: 0.95; }
          10% { opacity: 0.9; }
          15% { opacity: 0.85; }
          20% { opacity: 0.95; }
          25% { opacity: 0.85; }
          30% { opacity: 0.9; }
          35% { opacity: 0.95; }
          40% { opacity: 0.85; }
          45% { opacity: 0.9; }
          50% { opacity: 0.95; }
          55% { opacity: 0.85; }
          60% { opacity: 0.9; }
          65% { opacity: 0.95; }
          70% { opacity: 0.9; }
          75% { opacity: 0.85; }
          80% { opacity: 0.9; }
          85% { opacity: 0.95; }
          90% { opacity: 0.85; }
          95% { opacity: 0.9; }
          100% { opacity: 0.95; }
        }

        body {
          background: var(--bg-color);
          color: var(--main-color);
          font-family: 'VT323', monospace;
          min-height: 100vh;
          animation: textShadow 1.6s infinite;
          position: relative;
          overflow-x: hidden;
        }

        .horizontal-lines {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: repeating-linear-gradient(
            0deg,
            transparent,
            transparent 1px,
            rgba(0, 255, 255, 0.05) 2px,
            rgba(0, 255, 255, 0.05) 3px
          );
          pointer-events: none;
          z-index: 998;
        }

        .vertical-lines {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: repeating-linear-gradient(
            90deg,
            transparent,
            transparent 5px,
            rgba(0, 255, 255, 0.02) 6px,
            rgba(0, 255, 255, 0.02) 10px
          );
          pointer-events: none;
          z-index: 997;
        }

        .glitch-lines {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          pointer-events: none;
          z-index: 1000;
        }

        .content {
          position: relative;
          z-index: 1;
          padding: 20px;
        }

        header {
          text-align: center;
          margin: 40px 0;
        }

        header h1 {
          font-family: 'Press Start 2P', cursive;
          font-size: 2.5rem;
          color: var(--main-color);
          text-transform: uppercase;
          margin-bottom: 20px;
          line-height: 1.4;
          text-shadow: 4px 4px var(--secondary-color);
        }

        header p {
          font-size: 1.5rem;
          color: var(--main-color);
        }

        .hologram-container {
          width: 90%;
          max-width: 800px;
          margin: 20px auto;
          position: relative;
        }

        .content-wrapper {
          position: relative;
          border: 2px solid var(--main-color);
          padding: 4px;
          background: rgba(0, 255, 255, 0.1);
        }

        .hologram-frame {
          width: 100%;
          height: auto;
          display: block;
        }

        .content-overlay {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 80%;
          text-align: center;
        }

        .content-overlay h2 {
          font-family: 'Press Start 2P', cursive;
          font-size: 1.5rem;
          color: var(--main-color);
          margin-bottom: 15px;
        }

        .content-overlay p {
          font-size: 1.2rem;
          margin-bottom: 20px;
        }

        .download-button {
          font-family: 'Press Start 2P', cursive;
          display: inline-block;
          padding: 15px 30px;
          background: transparent;
          color: var(--main-color);
          text-decoration: none;
          font-size: 1rem;
          border: 2px solid var(--main-color);
          text-transform: uppercase;
          position: relative;
          overflow: hidden;
          transition: all 0.3s;
          cursor: pointer;
        }

        .download-button:hover {
          background: var(--main-color);
          color: var(--bg-color);
          text-shadow: none;
        }

        .comment-section {
          width: 90%;
          max-width: 800px;
          margin: 40px auto;
          border: 2px solid var(--main-color);
          padding: 20px;
          background: rgba(0, 255, 255, 0.05);
        }

        .gallery-title {
          font-family: 'Press Start 2P', cursive;
          font-size: 1.5rem;
          text-align: center;
          margin-bottom: 30px;
          color: var(--main-color);
        }

        .rating-container {
          display: flex;
          gap: 10px;
          margin: 20px 0;
          justify-content: center;
        }

        .rating-star {
          font-size: 24px;
          cursor: pointer;
          color: rgba(0, 255, 255, 0.3);
          transition: color 0.3s;
        }

        .rating-star.active {
          color: var(--main-color);
        }

        .form-group {
          margin-bottom: 15px;
        }

        .form-label {
          display: block;
          margin-bottom: 5px;
          color: var(--main-color);
          font-size: 1.1rem;
        }

        .form-input,
        .form-textarea {
          width: 100%;
          padding: 10px;
          background: rgba(0, 255, 255, 0.1);
          border: 2px solid var(--main-color);
          color: var(--main-color);
          font-family: 'VT323', monospace;
          font-size: 1.1rem;
        }

        .form-textarea {
          min-height: 100px;
          resize: vertical;
        }

        .submit-button {
          font-family: 'Press Start 2P', cursive;
          padding: 10px 20px;
          background: transparent;
          color: var(--main-color);
          border: 2px solid var(--main-color);
          cursor: pointer;
          font-size: 1rem;
          transition: all 0.3s;
        }

        .submit-button:hover {
          background: var(--main-color);
          color: var(--bg-color);
        }

        .comments-list {
          margin: 20px 0;
          padding: 0;
          list-style: none;
        }

        .comment-item {
          border: 1px solid var(--main-color);
          margin-bottom: 15px;
          padding: 15px;
          background: rgba(0, 255, 255, 0.05);
        }

        .comment-header {
          display: flex;
          justify-content: space-between;
          margin-bottom: 10px;
          font-size: 0.9rem;
          color: var(--secondary-color);
        }

        .comment-content {
          font-size: 1.1rem;
        }

        .login-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }

        .login-modal {
          background: var(--bg-color);
          border: 2px solid var(--main-color);
          padding: 20px;
          width: 90%;
          max-width: 400px;
          position: relative;
        }

        footer {
          text-align: center;
          padding: 20px;
          color: var(--main-color);
          font-size: 1rem;
          margin-top: 40px;
        }

        @media (max-width: 768px) {
          header h1 {
            font-size: 1.8rem;
          }
        }

        .login-area {
          text-align: center;
          margin-bottom: 20px;
        }
        
        .auth-buttons {
          text-align: center;
          margin: 20px 0;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }

        .login-info {
          margin-top: 10px;
          color: var(--secondary-color);
        }

        .user-info {
          text-align: center;
          margin: 20px 0;
          padding: 10px;
          border: 1px solid var(--main-color);
          background: rgba(0, 255, 255, 0.05);
        }

        .error-message {
          color: var(--secondary-color);
          text-align: center;
          margin: 10px 0;
        }

        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
      `}</style>
    </>
  )
}

